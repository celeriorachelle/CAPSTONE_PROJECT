<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notifications | Everlasting Peace Memorial Park</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/stylesheets/notification.css">
</head>
<body>
  <!-- Sidebar -->
  <%- include('partials/sidebar') %>

  <div class="main" id="main">
    <!-- Topbar -->
    <%- include('partials/topbar', { title: "Notifications" }) %>

    <div class="container main-content">
      <section class="section-card">
        <h2 class="section-title" style="margin-bottom:12px;">Notifications</h2>
        <div id="notificationList" class="notifications-list"><!-- JS will fill this --></div>
        <div style="margin-top:12px; text-align:right;">
          <button id="markReadBtn" class="btn-mark">Mark all as read</button>
        </div>
      </section>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <%- include('partials/footer') %>
    </footer>
  </div>

<script>
async function loadNotifications() {
  try {
    const res = await fetch('/notifications/json');
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

    const notifications = await res.json();
    const list = document.getElementById('notificationList');
    list.innerHTML = '';

    if (!notifications || notifications.length === 0) {
      list.innerHTML = '<p>No notifications yet.</p>';
      return;
    }

    notifications.forEach(notif => {
      const message = notif.message || 'No message';
      const formattedDate = (notif.created_at || notif.datestamp) ? new Date(notif.created_at || notif.datestamp).toLocaleString() : '';

      const item = document.createElement('div');
      item.className = `notification-item ${notif.read ? 'read' : 'unread'}`;
      item.innerHTML = `
        <i class="fas fa-envelope"></i>
        <div>
          <p class="message">${message}</p>
          <small>${formattedDate}</small>
        </div>
      `;
      list.appendChild(item);
    });
  } catch (err) {
    console.error("Error loading notifications:", err);
    document.getElementById('notificationList').innerHTML = '<p>Failed to load notifications.</p>';
  }
}

async function markAllRead() {
  try {
    const res = await fetch('/notifications/mark-read', { method: 'POST' });
    if (!res.ok) throw new Error('Failed to mark notifications read');
    await loadNotifications();
  } catch (err) {
    console.error("Mark read error:", err);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  loadNotifications();
  const btn = document.getElementById('markReadBtn');
  if (btn) btn.addEventListener('click', markAllRead);
  setInterval(loadNotifications, 30000);
});
</script>
</body>
</html>