<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bookings & Payments | Everlasting Peace Memorial Park</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="/stylesheets/adminviewapp.css">
  <style>
        body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background-color: #f4f6f8;
      color: #333;
    }

    .filter-select {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 25px;
      padding: 0.5rem 1rem;
      transition: all 0.3s ease;
      min-width: 200px;
      font-size: 14px;
    }

    .filter-select:hover {
      border-color: #8aac7c;
      background: white;
      box-shadow: 0 0 0 3px rgba(138, 172, 124, 0.1);
    }

    /* =============== MODALS DESIGN =============== */
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: #fff;
      border-radius: 20px;
      padding: 2rem;
      width: 95%;
      max-width: 450px;
      position: relative;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-content h3 {
      margin-top: 0;
      color: #4a6b46;
      border-bottom: 2px solid #8aac7c;
      padding-bottom: 0.5rem;
      text-align: center;
      font-weight: 600;
    }

    .modal-content p { margin: 10px 0; font-size: 15px; }
    .modal-content b { color: #4a6b46; }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 20px;
      color: #777;
      cursor: pointer;
      transition: 0.3s ease;
    }

    .close-btn:hover { color: #e74c3c; transform: scale(1.2); }

    #emailModal textarea {
      width: 100%;
      height: 120px;
      border-radius: 10px;
      border: 1px solid #ccc;
      padding: 0.8rem;
      font-size: 14px;
      resize: none;
      margin-top: 10px;
      outline: none;
      transition: 0.3s ease;
    }

    #emailModal textarea:focus {
      border-color: #8aac7c;
      box-shadow: 0 0 5px rgba(138, 172, 124, 0.3);
    }

    .btn-send {
      display: block;
      width: 100%;
      background: #8aac7c;
      color: white;
      border: none;
      border-radius: 25px;
      padding: 0.8rem;
      font-size: 15px;
      margin-top: 15px;
      cursor: pointer;
      transition: 0.3s ease;
      font-weight: 500;
    }

    .btn-send:hover {
      background: #7aa36f;
      box-shadow: 0 4px 10px rgba(122, 163, 111, 0.3);
      transform: translateY(-2px);
    }

    #viewModal p span {
      color: #555;
      background: #f9f9f9;
      padding: 4px 8px;
      border-radius: 6px;
      margin-left: 5px;
      display: inline-block;
      font-weight: 500;
    }

    .btn-action {
      border: none;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      transition: 0.3s ease;
    }

    .btn-view { background: #6fbf73; color: white; }
    .btn-view:hover { background: #63a965; }

    .btn-edit { background: #4a90e2; color: white; }
    .btn-edit:hover { background: #3b7ac2; }

    .empty-state {
      text-align: center;
      color: #777;
      padding: 2rem;
    }

    .empty-state i {
      font-size: 40px;
      color: #8aac7c;
    }
  </style>
</head>

<body>
  <!-- existing header and sidebar remain the same -->
  <header class="admin-header">
    <h1>Admin Dashboard</h1>
    <nav>
      <ul>
        <li><a href="/admin" class="active"><i class="fas fa-home"></i> Home</a></li>
        <li><a href="/adminviewapp"><i class="fas fa-calendar-alt"></i> View Bookings</a></li>
        <li><a href="/adminviewbookings"><i class="fas fa-book"></i>Transactions</a></li>
        <li><a href="/reports"><i class="fas fa-chart-bar"></i> Reports</a></li>
        <li><a href="/login/logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
      </ul>
    </nav>
  </header>

  <main class="admin-main">
    <aside class="sidebar">
      <h3><i class="fas fa-book"></i> Bookings & Payments</h3>
      <ul>
        <li><a href="/admin"><i class="fas fa-home"></i> Dashboard Home</a></li>
        <li><a href="/admincreateb"><i class="fas fa-plus-circle"></i> Create Booking</a></li>
        <li><a href="/adminviewapp"><i class="fas fa-list"></i> View Booking</a></li>
        <li><a href="/burialrecord"><i class="fas fa-book"></i> Burial Records</a></li>
        <li><a href="/maps"><i class="fas fa-map"></i> Cemetery Map</a></li>
        <li><a href="/adminviewbookings" class="active"><i class="fas fa-list"></i> Client Transactions</a></li>
        <li><a href="/admin_inventory"><i class="fas fa-clipboard-list"></i> Inventory</a></li>
        <li><a href="/admin_logs"><i class="fas fa-clipboard-list"></i> Logs</a></li>
      </ul>
    </aside>

    <section class="content">
      <div class="content-header">
        <h2>All Bookings & Payments</h2>
        <div class="search-controls">
          <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Search bookings...">
          </div>

          <select id="paymentFilter" class="filter-select">
            <option value="">All Payment Types</option>
            <option value="downpayment">Downpayment</option>
            <option value="fullpayment">Full Payment</option>
          </select>

          <!-- ✅ Added Date Filter -->
          <input type="date" id="dateFilter" class="filter-select">
        </div>
      </div>

      <div class="appointments-container">
        <div class="table-header">
          <h3><i class="fas fa-list"></i> Bookings Overview</h3>
        </div>

        <div style="overflow-x: auto;">
          <table class="appointments-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Client Name</th>
                <th>Contact</th>
                <th>Email</th>
                <th>Service</th>
                <th>Booking Date</th>
                <th>Booking Status</th>
                <th>Payment Type</th>
                <th>Payment Status</th>
                <th>Amount</th>
                <th>Due Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (bookings.length === 0) { %>
                <tr>
                  <td colspan="15" class="empty-state">
                    <i class="fas fa-folder-open"></i>
                    <h3>No Bookings Found</h3>
                  </td>
                </tr>
              <% } else { %>
                <% bookings.forEach(b => { %>
                  <tr>
                    <td><%= b.id %></td>
                    <td><%= (b.lastName || '') + (b.firstName ? ', ' + b.firstName : '') %></td>
                    <td><%= b.phone || '—' %></td>
                    <td><%= b.email || '—' %></td>
                    <td><%= b.service || '—' %></td>
                    <td><%= b.bookingDate ? new Date(b.bookingDate).toLocaleDateString() : '—' %></td>
                    <td><%= b.bookingStatus || 'N/A' %></td>
                    <td><%= b.paymentType || '—' %></td>
                    <td><%= b.paymentStatus || 'N/A' %></td>
                    <td>₱<%= b.amount ? parseFloat(b.amount).toFixed(2) : '0.00' %></td>
                    <td><%= b.dueDate ? new Date(b.dueDate).toLocaleDateString() : '—' %></td>
                    <td>
                      <button onclick="openViewModal('<%= b.plotNumber %>', '<%= b.location %>', '<%= b.plotType %>', '<%= b.firstName %>', '<%= b.lastName %>', '<%= b.paymentType %>')" class="btn-action btn-view">
                        <i class="fas fa-eye"></i> View
                      </button>

                      <!-- ✅ Added AUTO EMAIL button -->
                      <button onclick="sendAutoReminder(<%= b.id %>)" class="btn-action btn-view" style="background:#9b59b6;">
                        <i class="fas fa-robot"></i> Auto Email
                      </button>

                      <!-- existing manual email button -->
                      <button onclick="openEmailModal(<%= b.id %>, '<%= b.email %>')" class="btn-action btn-edit">
                        <i class="fas fa-envelope"></i> Manual Email
                      </button>
                    </td>
                  </tr>
                <% }) %>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- VIEW MODAL -->
  <div class="modal" id="viewModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('viewModal')">&times;</span>
      <h3>Booking Details</h3>
      <p><b>Plot Number:</b> <span id="viewPlot"></span></p>
      <p><b>Location:</b> <span id="viewLocation"></span></p>
      <p><b>Type:</b> <span id="viewType"></span></p>
      <p><b>Client:</b> <span id="viewName"></span></p>
      <p><b>Payment Type:</b> <span id="viewPayment"></span></p>
    </div>
  </div>

  <!-- EMAIL MODAL -->
  <div class="modal" id="emailModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('emailModal')">&times;</span>
      <h3>Send Reminder Email</h3>
      <p><b>Recipient:</b> <span id="emailRecipient"></span></p>
      <textarea id="emailMessage" placeholder="Type your message here..."></textarea>
      <button class="btn-send" onclick="sendReminder()">Send Email</button>
    </div>
  </div>

  <script>
    let currentBookingId = null;

    function openViewModal(plot, location, type, fname, lname, payment) {
      document.getElementById('viewPlot').innerText = plot || '—';
      document.getElementById('viewLocation').innerText = location || '—';
      document.getElementById('viewType').innerText = type || '—';
      document.getElementById('viewName').innerText = lname + ', ' + fname;
      document.getElementById('viewPayment').innerText = payment || '—';
      document.getElementById('viewModal').style.display = 'flex';
    }

    function openEmailModal(id, email) {
      currentBookingId = id;
      document.getElementById('emailRecipient').innerText = email;
      document.getElementById('emailMessage').value = `We are Everlasting Peace Memorial Park Cemetery.\n\nDear client, this is a gentle reminder regarding your booking.`;
      document.getElementById('emailModal').style.display = 'flex';
    }

    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    function sendReminder() {
      const message = document.getElementById('emailMessage').value;
      fetch(`/adminviewbookings/send-reminder/${currentBookingId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.success ? 'Email sent successfully!' : 'Failed to send email.');
        closeModal('emailModal');
      })
      .catch(() => alert('Error sending email.'));
    }

    // ✅ NEW FUNCTION for Automatic Email
    function sendAutoReminder(bookingId) {
      if (!confirm('Send automatic due date reminder?')) return;
      fetch(`/adminviewbookings/send-auto-reminder/${bookingId}`, {
        method: 'POST'
      })
      .then(res => res.json())
      .then(data => {
        alert(data.success ? 'Automatic reminder sent successfully!' : 'Failed to send automatic reminder.');
      })
      .catch(() => alert('Error sending automatic reminder.'));
    }

    // ✅ FIXED SEARCH, FILTER, DATE FILTER
    const searchInput = document.getElementById('searchInput');
    const paymentFilter = document.getElementById('paymentFilter');
    const dateFilter = document.getElementById('dateFilter');

    function filterTable() {
      const searchTerm = searchInput.value.toLowerCase();
      const selectedPayment = paymentFilter.value.toLowerCase();
      const selectedDate = dateFilter.value;

      document.querySelectorAll('.appointments-table tbody tr').forEach(row => {
        if (row.classList.contains('empty-state') || row.querySelector('.empty-state')) return;
        const rowText = row.textContent.toLowerCase();
        const paymentType = row.children[7]?.textContent.toLowerCase() || '';
        const bookingDate = row.children[5]?.textContent.trim();

        const matchesSearch = rowText.includes(searchTerm);
        const matchesPayment = !selectedPayment || paymentType.includes(selectedPayment);
        const matchesDate = !selectedDate || (bookingDate && new Date(bookingDate).toLocaleDateString() === new Date(selectedDate).toLocaleDateString());

        row.style.display = matchesSearch && matchesPayment && matchesDate ? '' : 'none';
      });
    }

    searchInput.addEventListener('keyup', filterTable);
    paymentFilter.addEventListener('change', filterTable);
    dateFilter.addEventListener('change', filterTable);
  </script>
</body>
</html>
