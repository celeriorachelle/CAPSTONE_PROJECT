<!DOCTYPE html>
<html>
<head>
  <title>Cemetery Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <style>
    .map-container { max-width: 1200px; margin: 0 auto; }
    #map { height: 700px; width: 100%; border: 1px solid #ddd; border-radius: 8px; }
    .info-box { margin-top: 12px; padding: 12px; background: #fff; border: 1px solid #ddd; border-radius: 6px; min-height: 60px; }
  </style>
</head>
<body>
  <div class="map-container">
    <h3>Cemetery Map (Click a Section)</h3>
    <div id="map"></div>
    <div id="infoBox" class="info-box">
      <em>Click a section to view plots. You can also draw/edit polygons.</em>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <script>
   // ----- 1. Preloaded sections -----
  const currentSections = {
  "Family Estates": { "coords":[[{"lat":285.9296875,"lng":344.625},{"lat":326.9296875,"lng":473.625},{"lat":214.1796875,"lng":499.875},{"lat":172.1796875,"lng":372.625}]], "color":"#4A90E2" },
  "Family Estates ": { "coords":[[{"lat":284.4296875,"lng":377.5},{"lat":290.4296875,"lng":397},{"lat":257.6796875,"lng":404.75},{"lat":250.6796875,"lng":384.5}]], "color":"#E24A90" },
  "LEVEL 1": { "coords":[[{"lat":338.4296875,"lng":588.125},{"lat":344.1796875,"lng":603.625},{"lat":315.9296875,"lng":610.625},{"lat":311.1796875,"lng":595.125}]], "color":"#904AE2" },
  "LEVEL 2": { "coords":[[{"lat":302.6796875,"lng":596.625},{"lat":308.1796875,"lng":613.125},{"lat":279.1796875,"lng":619.625},{"lat":274.6796875,"lng":602.625}]], "color":"#904AE2" },
  "LEVEL 3": { "coords":[[{"lat":266.9296875,"lng":604.875},{"lat":271.9296875,"lng":620.875},{"lat":243.6796875,"lng":628.875},{"lat":239.4296875,"lng":612.375}]], "color":"#904AE2" },
  "Heritage Garden A": { "coords":[[{"lat":433.58984375,"lng":636.1875},{"lat":453.08984375,"lng":636.1875},{"lat":453.08984375,"lng":663.0625},{"lat":433.58984375,"lng":663.0625}]], "color":"#E24A90" },
  "Heritage Garden B": { "coords":[[{"lat":432.33984375,"lng":669.9375},{"lat":452.96484375,"lng":669.9375},{"lat":452.96484375,"lng":696.6875},{"lat":432.33984375,"lng":696.6875}]], "color":"#E2904A" },
  "Veterans Memorial A": { "coords":[[{"lat":448.96484375,"lng":793.8125},{"lat":468.33984375,"lng":793.8125},{"lat":468.33984375,"lng":820.9375},{"lat":448.96484375,"lng":820.9375}]], "color":"#90E24A" },
  "Veterans Memorial B": { "coords":[[{"lat":448.08984375,"lng":890.5625},{"lat":468.83984375,"lng":890.5625},{"lat":468.83984375,"lng":918.0625},{"lat":448.08984375,"lng":918.0625}]], "color":"#E24A90" },
  "Serenity Columbarium A": { "coords":[[{"lat":194.1796875,"lng":795.375},{"lat":212.6796875,"lng":795.375},{"lat":212.6796875,"lng":821.375},{"lat":194.1796875,"lng":821.375}]], "color":"#4A90E2" },
  "Serenity Columbarium B": { "coords":[[{"lat":193.9296875,"lng":888.875},{"lat":212.1796875,"lng":888.875},{"lat":212.1796875,"lng":916.125},{"lat":193.9296875,"lng":916.125}]], "color":"#904AE2" },
  "OPEN SPACE": { "coords":[[{"lat":129.359375,"lng":538.75},{"lat":151.359375,"lng":759.25},{"lat":91.859375,"lng":762.25},{"lat":71.859375,"lng":543.75}]], "color":"#904AE2" },
  "CHAPEL": { "coords":[[{"lat":91.58984375,"lng":283.9375},{"lat":98.21484375,"lng":343.9375},{"lat":45.4296875,"lng":349.875},{"lat":38.1796875,"lng":289.125}]], "color":"#E24A90" },
  "OFFICE": { "coords":[[{"lat":101.9296875,"lng":362.375},{"lat":108.9296875,"lng":423.125},{"lat":57.1796875,"lng":427.875},{"lat":48.9296875,"lng":366.875}]], "color":"#90E24A" },
  "CREMATORIUM": { "coords":[[{"lat":114.9296875,"lng":441.125},{"lat":122.6796875,"lng":518.375},{"lat":70.4296875,"lng":522.875},{"lat":62.6796875,"lng":445.875}]], "color":"#E2904A" },
  "Memorial Chapel & Administration": { "coords":[[{"lat":317.9296875,"lng":498.875},{"lat":352.6796875,"lng":607.125},{"lat":238.6796875,"lng":635.375},{"lat":205.1796875,"lng":526.625}]], "color":"#E24A90" },
  "Heritage Gardens": { "coords":[[{"lat":427.859375,"lng":631.25},{"lat":608.859375,"lng":631.25},{"lat":608.859375,"lng":701.75},{"lat":427.859375,"lng":701.75}]], "color":"#90E24A" },
  "Veterans Memorial": { "coords":[[{"lat":444.359375,"lng":753.25},{"lat":624.359375,"lng":753.25},{"lat":624.359375,"lng":920.25},{"lat":444.359375,"lng":920.25}]], "color":"#E2904A" },
  "Serenity Columbarium": { "coords":[[{"lat":186.359375,"lng":754.25},{"lat":368.859375,"lng":754.25},{"lat":368.859375,"lng":921.25},{"lat":186.359375,"lng":921.25}]], "color":"#904AE2" },
  "ENTRANCE": { "coords":[[{"lat":145.359375,"lng":189.25},{"lat":172.359375,"lng":229.75},{"lat":110.859375,"lng":261.25},{"lat":87.859375,"lng":219.25}]], "color":"#4A90E2" }
};
    // ----- 2. Initialize Map -----
    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -2,
      maxZoom: 2,
      zoom: 0,
      center: [0,0]
    });

    const imgWidth = 4269;
    const imgHeight = 2400;
    const bounds = [[0, 0], [imgHeight, imgWidth]];
    L.imageOverlay('/images/newmap.png', bounds).addTo(map);
    map.fitBounds(bounds);

    // ----- 3. Feature Group for polygons -----
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: { polygon: true, rectangle: true, circle: false, marker: false, polyline: false }
    });
    map.addControl(drawControl);

    // ----- 4. Render sections -----
    Object.keys(currentSections).forEach(name => {
      currentSections[name].coords.forEach(coordSet => {
        const latlngs = coordSet.map(pt => [pt.lat, pt.lng]);

        const polygon = L.polygon(latlngs, {
          color: currentSections[name].color,
          fillColor: currentSections[name].color,
          fillOpacity: 0.2,
          weight: 2
        }).addTo(drawnItems);

        // Hover effect
        polygon.on('mouseover', () => polygon.setStyle({ fillOpacity: 0.5 }));
        polygon.on('mouseout', () => polygon.setStyle({ fillOpacity: 0.2 }));

        // Click to show plots
        polygon.on('click', async () => {
          const bounds = polygon.getBounds();
          const south = Math.min(bounds.getSouth(), bounds.getNorth());
          const north = Math.max(bounds.getSouth(), bounds.getNorth());
          const west  = Math.min(bounds.getWest(), bounds.getEast());
          const east  = Math.max(bounds.getWest(), bounds.getEast());

          try {
            const res = await fetch(`/plots/in-bounds?latMin=${south}&latMax=${north}&lngMin=${west}&lngMax=${east}`);
            const plots = await res.json();

            let html = `<b>${name}</b>:<br>`;
            if (!plots || plots.length === 0) html += "No plots in this section.";
            else {
              html += '<ul>';
              plots.forEach(p => {
                html += `<li>${p.plot_number} - ${p.deceased_firstName || ''} ${p.deceased_lastName || ''} (${p.type || ''})</li>`;
              });
              html += '</ul>';
            }
            document.getElementById('infoBox').innerHTML = html;
          } catch (err) {
            console.error(err);
            document.getElementById('infoBox').innerHTML = "Error fetching plots.";
          }
        });
      });
    });

    // ----- 5. Handle newly drawn polygons -----
    map.on(L.Draw.Event.CREATED, function (e) {
      const layer = e.layer;
      drawnItems.addLayer(layer);
      console.log("âœ… New polygon added:", layer.getLatLngs());
    });

  </script>
</body>
</html>
