<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>View Your Bookings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/stylesheets/viewbooking.css">
</head>
<body>
  <!-- Sidebar -->
  <%- include('partials/sidebar') %>

  <div class="main" id="main">
    <!-- Topbar -->
    <%- include('partials/topbar', { title: "View Your Bookings" }) %>

    <div class="main-content">
      <!-- Filter -->
      <div class="filter-section" style="margin-bottom: 20px;">
        <form method="GET" action="/viewbooking">
          <label for="type">Filter by Booking Type:</label>
          <select name="type" id="type" onchange="this.form.submit()">
            <option value="" <%= !filterType ? 'selected' : '' %>>All</option>
            <option value="plot-booking" <%= filterType === 'plot-booking' ? 'selected' : '' %>>Plot Booking</option>
            <option value="memorial" <%= filterType === 'memorial' ? 'selected' : '' %>>Memorial</option>
            <option value="burial" <%= filterType === 'burial' ? 'selected' : '' %>>Burial</option>
          </select>
          <input type="hidden" name="limit" value="<%= limit %>">
        </form>
      </div>

      <% const types = ['plot-booking', 'memorial', 'burial']; %>

      <% types.forEach(type => { %>
        <h2 style="margin-top:20px; text-transform:capitalize;">
          <%= type.replace('-', ' ') %> Bookings
        </h2>

        <% if (bookingsGrouped[type] && bookingsGrouped[type].length > 0) { %>
          <table>
            <thead>
              <tr>
                <th>Booking Date</th>
                <th>Visit Time</th>
                <th>Status</th>
                <th>Notes</th>
                <% if (type === 'plot-booking') { %>
                  <th>Plot Info</th>
                <% } %>
              </tr>
            </thead>
            <tbody>
              <% bookingsGrouped[type].forEach(b => { %>
                <tr>
                  <td><%= b.booking_date ? new Date(b.booking_date).toLocaleDateString() : '-' %></td>
                  <td><%= b.visit_time || '-' %></td>
                  <td style="font-weight:bold; color:<%= b.status === 'pending' ? 'orange' : b.status === 'approved' ? 'green' : 'red' %>">
                    <%= b.status.charAt(0).toUpperCase() + b.status.slice(1) %>
                  </td>
                  <td><%= b.notes || '-' %></td>
                  <% if (type === 'plot-booking') { %>
                    <td><%= b.plot_type || '-' %> - <%= b.plot_number || '-' %> (<%= b.location || '-' %>)</td>
                  <% } %>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } else { %>
          <p>No <%= type.replace('-', ' ') %> bookings found.</p>
        <% } %>
      <% }) %>

      <!-- Pagination -->
      <% if (totalPages > 1) { %>
        <div class="pagination" style="margin-top:20px;">
          <% if (page > 1) { %>
            <a href="/viewbooking?page=<%= page - 1 %>&limit=<%= limit %>&type=<%= filterType %>">Previous</a>
          <% } %>

          <% for (let i = 1; i <= totalPages; i++) { %>
            <a href="/viewbooking?page=<%= i %>&limit=<%= limit %>&type=<%= filterType %>" 
               class="<%= i === page ? 'active' : '' %>">
              <%= i %>
            </a>
          <% } %>

          <% if (page < totalPages) { %>
            <a href="/viewbooking?page=<%= page + 1 %>&limit=<%= limit %>&type=<%= filterType %>">Next</a>
          <% } %>
        </div>
      <% } %>

      <div class="back-button" style="margin-top:20px;">
        <a href="/book">‚Üê Back to Booking Page</a>
      </div>
    </div>

    <footer class="footer">
      <%- include('partials/footer') %>
    </footer>
  </div>
</body>
</html>
